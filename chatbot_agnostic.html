<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siksha-Sarathi Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }

        /* Custom scrollbar styles */
        #chatContainer::-webkit-scrollbar {
            width: 8px;
        }

        #chatContainer::-webkit-scrollbar-track {
            background: #f1f5e6;
            border-radius: 10px;
        }

        #chatContainer::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        #chatContainer::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Style for the typing indicator */
        #typingIndicator::after {
            overflow: hidden;
            display: inline-block;
            vertical-align: bottom;
            -webkit-animation: ellipsis steps(4,end) 900ms infinite;
            animation: ellipsis steps(4,end) 900ms infinite;
            content: "\2026";
            width: 0px;
        }

        @keyframes ellipsis {
            to {
                width: 1.25em;
            }
        }

        /* Language dropdown styles */
        .language-dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 120px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1;
            border: 1px solid #e5e7eb;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content button {
            color: #374151;
            padding: 8px 16px;
            text-decoration: none;
            display: block;
            width: 100%;
            text-align: left;
            border: none;
            background: none;
            border-radius: 0;
        }

        .dropdown-content button:hover {
            background-color: #f3f4f6;
        }

        .dropdown-content button:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-content button:last-child {
            border-radius: 0 0 8px 8px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Authentication Screen -->
    <div id="authScreen" class="bg-white rounded-3xl shadow-xl w-full max-w-md p-8">
        <div class="text-center mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-indigo-600 mx-auto mb-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
            </svg>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Siksha-Sarathi</h1>
            <p class="text-gray-600">Your Campus Assistant</p>
        </div>

        <!-- Login Form -->
        <div id="loginForm">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Sign In</h2>
            <form id="loginFormElement" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email or Student ID</label>
                    <input type="text" id="loginEmail" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your email or student ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="loginPassword" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your password">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition-colors font-medium">Sign In</button>
            </form>
            <p class="text-center mt-4 text-gray-600">
                Don't have an account? 
                <button id="showSignup" class="text-indigo-600 hover:text-indigo-700 font-medium">Sign Up</button>
            </p>
        </div>

        <!-- Signup Form -->
        <div id="signupForm" class="hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-6 text-center">Create Account</h2>
            <form id="signupFormElement" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                    <input type="text" id="signupName" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your full name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="signupEmail" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your email">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Student ID</label>
                    <input type="text" id="signupStudentId" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Enter your student ID">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="signupPassword" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Create a password">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password</label>
                    <input type="password" id="confirmPassword" required class="w-full p-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Confirm your password">
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl hover:bg-indigo-700 transition-colors font-medium">Create Account</button>
            </form>
            <p class="text-center mt-4 text-gray-600">
                Already have an account? 
                <button id="showLogin" class="text-indigo-600 hover:text-indigo-700 font-medium">Sign In</button>
            </p>
        </div>
    </div>

    <!-- Main Chatbot Container -->
    <div id="chatbotScreen" class="bg-white rounded-3xl shadow-xl w-full max-w-2xl flex flex-col h-[85vh] overflow-hidden hidden">
        
        <!-- Header -->
        <header class="bg-white p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <div>
                    <h1 class="text-xl font-bold text-gray-800" data-translate="title">Siksha-Sarathi</h1>
                    <p class="text-xs text-gray-500">Welcome, <span id="userName">Student</span></p>
                </div>
            </div>
            <div class="flex items-center space-x-4 text-gray-600">
                <!-- Language Dropdown -->
                <div class="language-dropdown">
                    <button id="languageDropdownBtn" class="flex items-center space-x-1 text-sm font-medium hover:text-indigo-600 px-2 py-1 rounded">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                        </svg>
                        <span id="currentLanguage">EN</span>
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div id="languageDropdown" class="dropdown-content">
                        <button onclick="changeLanguage('en')">English</button>
                        <button onclick="changeLanguage('hi')">हिंदी</button>
                        <button onclick="changeLanguage('bn')">বাংলা</button>
                        <button onclick="changeLanguage('mwr')">मारवाड़ी</button>
                        <button onclick="changeLanguage('or')">ଓଡ଼ିଆ</button>
                    </div>
                </div>
                <button id="talkToHumanButton" class="flex items-center space-x-1 text-sm font-medium hover:text-indigo-600" data-query-key="talk_to_human">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 13c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/>
                    </svg>
                    <span data-translate="talk_to_human">Talk to Human</span>
                </button>
                <button id="logoutButton" class="flex items-center space-x-1 text-sm font-medium hover:text-red-600" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Chat Messages -->
        <div id="chatContainer" class="flex-grow p-4 overflow-y-auto space-y-4">
            <!-- Initial bot message -->
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-8 w-8 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </div>
                <div class="p-3 rounded-xl bg-gray-200 text-gray-800 rounded-bl-none max-w-[75%] shadow-md">
                    <span data-translate="initial_message">Hello! Namaste! வணக்கம்! I can help you with your campus questions in any language. How can I assist you today?</span>
                    <div class="flex items-center text-xs text-gray-500 mt-2 space-x-1">
                        <span>11:15 AM</span>
                        <span>|</span>
                        <span>EN</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div id="quickActionsContainer" class="p-4 bg-white border-t border-gray-200">
            <h3 class="text-sm font-semibold text-gray-500 mb-2" data-translate="quick_actions">Quick Actions</h3>
            <div class="grid grid-cols-4 gap-2 text-center">
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="fee_information">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm10 14H4V8h16v10z"/></svg>
                    <span data-translate="fee_information">Fee Information</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="scholarships">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2L1 12h3v8h6v-6h4v6h6v-8h3L12 2zm0 14c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
                    <span data-translate="scholarships">Scholarships</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="timetable">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM5 19V9h14v10H5zm2-7h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
                    <span data-translate="timetable">Timetable</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="documents">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15 11c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zm-4 0c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zM7 11c.55 0 1-.45 1-1s-.45-1-1-1-1 .45-1 1 .45 1 1 1zM20 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zM4 19V7h16l.01 12H4z"/></svg>
                    <span data-translate="documents">Documents</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="campus_map">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    <span data-translate="campus_map">Campus Map</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="office_hours">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                    <span data-translate="office_hours">Office Hours</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="library">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h16v2H4z"/></svg>
                    <span data-translate="library">Library</span>
                </button>
                <button class="flex flex-col items-center justify-center p-2 text-xs text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors" data-query-key="contact">
                    <svg class="h-6 w-6 mb-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93s3.05-7.44 7-7.93v15.86zM12 4c-3.96 0-7.18 3.06-7.9 7H19.9c-.72-3.94-3.94-7-7.9-7z"/></svg>
                    <span data-translate="contact">Contact</span>
                </button>
            </div>
        </div>

        <!-- Input and Send area -->
        <footer class="p-4 bg-white border-t border-gray-200">
            <div class="flex items-center space-x-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.45-3c-.49 4.09-3.8 7.3-7.95 7.74V21h3v-2.16c3.42-.37 6.13-3.13 6.13-6.59h-2.13z"/>
                </svg>
                <input type="text" id="messageInput" data-translate-placeholder="input_placeholder" placeholder="Type your question here..." class="flex-grow p-3 rounded-xl bg-gray-100 border-none focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                <button id="sendButton" class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition-colors shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
            <div class="flex justify-center mt-2 space-x-4 text-xs text-gray-500">
                <span data-translate="multilingual_support">Multi-language AI Support</span>
                <span>•</span>
                <span data-translate="privacy_protected">Privacy Protected</span>
            </div>
        </footer>
    </div>
    
    <script>
        // Authentication system
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('sikshaUsers') || '[]');
        let currentSession = localStorage.getItem('sikshaSession');

        // DOM elements
        const authScreen = document.getElementById('authScreen');
        const chatbotScreen = document.getElementById('chatbotScreen');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const showSignupBtn = document.getElementById('showSignup');
        const showLoginBtn = document.getElementById('showLogin');
        const loginFormElement = document.getElementById('loginFormElement');
        const signupFormElement = document.getElementById('signupFormElement');
        const logoutButton = document.getElementById('logoutButton');
        const userName = document.getElementById('userName');

        // Chat elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const quickActionsContainer = document.getElementById('quickActionsContainer');
        const talkToHumanButton = document.getElementById('talkToHumanButton');

        // Initial state
        let conversationHistory = [];
        let currentLanguage = 'en';
        let isAutoDetectMode = true;

        // Language translations with query translations
        const translations = {
            en: {
                title: "Siksha-Sarathi",
                talk_to_human: "Talk to Human",
                initial_message: "Hello! Namaste! வணக்கம்! I can help you with your campus questions in any language. How can I assist you today?",
                quick_actions: "Quick Actions",
                fee_information: "Fee Information",
                scholarships: "Scholarships",
                timetable: "Timetable",
                documents: "Documents",
                campus_map: "Campus Map",
                office_hours: "Office Hours",
                library: "Library",
                contact: "Contact",
                input_placeholder: "Type your question here...",
                multilingual_support: "Multi-language AI Support",
                privacy_protected: "Privacy Protected",
                queries: {
                    fee_information: "Tell me about fee information",
                    scholarships: "What scholarships are available?",
                    timetable: "Show me the timetable",
                    documents: "What documents do I need?",
                    campus_map: "Show me the campus map",
                    office_hours: "What are the office hours?",
                    library: "Tell me about the library",
                    contact: "How can I contact the administration?",
                    talk_to_human: "I want to talk to a human"
                }
            },
            hi: {
                title: "शिक्षा-सारथी",
                talk_to_human: "मनुष्य से बात करें",
                initial_message: "नमस्ते! मैं आपके कैंपस प्रश्नों में किसी भी भाषा में मदद कर सकता हूं। आज मैं आपकी कैसे सहायता कर सकता हूं?",
                quick_actions: "त्वरित क्रियाएं",
                fee_information: "शुल्क जानकारी",
                scholarships: "छात्रवृत्ति",
                timetable: "समय सारणी",
                documents: "दस्तावेज",
                campus_map: "कैंपस मानचित्र",
                office_hours: "कार्यालय समय",
                library: "पुस्तकालय",
                contact: "संपर्क",
                input_placeholder: "यहाँ अपना प्रश्न टाइप करें...",
                multilingual_support: "बहुभाषी AI सहायता",
                privacy_protected: "गोपनीयता सुरक्षित",
                queries: {
                    fee_information: "मुझे फीस की जानकारी दें",
                    scholarships: "कौन सी छात्रवृत्तियां उपलब्ध हैं?",
                    timetable: "मुझे समय सारणी दिखाएं",
                    documents: "मुझे कौन से दस्तावेज चाहिए?",
                    campus_map: "मुझे कैंपस मानचित्र दिखाएं",
                    office_hours: "कार्यालय का समय क्या है?",
                    library: "मुझे पुस्तकालय के बारे में बताएं",
                    contact: "मैं प्रशासन से कैसे संपर्क कर सकता हूं?",
                    talk_to_human: "मैं किसी इंसान से बात करना चाहता हूं"
                }
            },
            bn: {
                title: "শিক্ষা-সারথী",
                talk_to_human: "মানুষের সাথে কথা বলুন",
                initial_message: "নমস্কার! আমি যেকোনো ভাষায় আপনার ক্যাম্পাস প্রশ্নে সাহায্য করতে পারি। আজ আমি আপনাকে কীভাবে সহায়তা করতে পারি?",
                quick_actions: "দ্রুত ক্রিয়া",
                fee_information: "ফি তথ্য",
                scholarships: "বৃত্তি",
                timetable: "সময়সূচি",
                documents: "নথি",
                campus_map: "ক্যাম্পাস মানচিত্র",
                office_hours: "অফিস সময়",
                library: "গ্রন্থাগার",
                contact: "যোগাযোগ",
                input_placeholder: "এখানে আপনার প্রশ্ন টাইপ করুন...",
                multilingual_support: "বহুভাষিক AI সহায়তা",
                privacy_protected: "গোপনীয়তা সুরক্ষিত",
                queries: {
                    fee_information: "আমাকে ফি সম্পর্কে তথ্য দিন",
                    scholarships: "কি বৃত্তি উপলব্ধ?",
                    timetable: "আমাকে সময়সূচি দেখান",
                    documents: "আমার কি নথি প্রয়োজন?",
                    campus_map: "আমাকে ক্যাম্পাস মানচিত্র দেখান",
                    office_hours: "অফিসের সময় কি?",
                    library: "আমাকে গ্রন্থাগার সম্পর্কে বলুন",
                    contact: "আমি প্রশাসনের সাথে কিভাবে যোগাযোগ করব?",
                    talk_to_human: "আমি একজন মানুষের সাথে কথা বলতে চাই"
                }
            },
            mwr: {
                title: "शिक्षा-सारथी",
                talk_to_human: "आदमी सूं बात करो",
                initial_message: "नमस्कार! म्हैं थारे कैंपस रे सवालां में कुण भी भाषा में मदद कर सकूं हूं। आज म्हैं थारी कैयां मदद कर सकूं हूं?",
                quick_actions: "झटपट काम",
                fee_information: "फीस री जाणकारी",
                scholarships: "छात्रवृत्ति",
                timetable: "टाइम टेबल",
                documents: "दस्तावेज",
                campus_map: "कैंपस नक्शो",
                office_hours: "दफ्तर रो टाइम",
                library: "पुस्तकालय",
                contact: "संपर्क",
                input_placeholder: "अठै आपणो सवाल लिखो...",
                multilingual_support: "घणी भाषावां री AI मदद",
                privacy_protected: "गुप्तता सुरक्षित",
                queries: {
                    fee_information: "म्हनै फीस री जाणकारी दो",
                    scholarships: "कुण सी छात्रवृत्ति मिल सकै है?",
                    timetable: "म्हनै टाइम टेबल दिखाओ",
                    documents: "म्हनै कुण से कागज चाहिए?",
                    campus_map: "म्हनै कैंपस रो नक्शो दिखाओ",
                    office_hours: "दफ्तर रो टाइम कुण सो है?",
                    library: "म्हनै पुस्तकालय रे बारे में बताओ",
                    contact: "म्हैं कोई आदमी सूं बात करणो चाहूं हूं"
                }
            },
            or: {
                title: "ଶିକ୍ଷା-ସାରଥୀ",
                talk_to_human: "ମଣିଷ ସହିତ କଥା କୁହନ୍ତୁ",
                initial_message: "ନମସ୍କାର! ମୁଁ ଯେକୌଣସି ଭାଷାରେ ଆପଣଙ୍କ କ୍ୟାମ୍ପସ ପ୍ରଶ୍ନରେ ସାହାଯ୍ୟ କରିପାରିବି। ଆଜି ମୁଁ ଆପଣଙ୍କୁ କିପରି ସାହାଯ୍ୟ କରିପାରିବି?",
                quick_actions: "ଦ୍ରୁତ କାର୍ଯ୍ୟ",
                fee_information: "ଫି ସୂଚନା",
                scholarships: "ଛାତ୍ରବୃତ୍ତି",
                timetable: "ସମୟ ସାରଣୀ",
                documents: "ଦଲିଲ",
                campus_map: "କ୍ୟାମ୍ପସ ମାନଚିତ୍ର",
                office_hours: "କାର୍ଯ୍ୟାଳୟ ସମୟ",
                library: "ପୁସ୍ତକାଳୟ",
                contact: "ଯୋଗାଯୋଗ",
                input_placeholder: "ଏଠାରେ ଆପଣଙ୍କ ପ୍ରଶ୍ନ ଟାଇପ୍ କରନ୍ତୁ...",
                multilingual_support: "ବହୁଭାଷୀ AI ସହାୟତା",
                privacy_protected: "ଗୋପନୀୟତା ସୁରକ୍ଷିତ",
                queries: {
                    fee_information: "ମୋତେ ଫି ସୂଚନା ଦିଅନ୍ତୁ",
                    scholarships: "କେଉଁ ଛାତ୍ରବୃତ୍ତି ଉପଲବ୍ଧ?",
                    timetable: "ମୋତେ ସମୟ ସାରଣୀ ଦେଖାନ୍ତୁ",
                    documents: "ମୋର କେଉଁ ଦଲିଲ ଦରକାର?",
                    campus_map: "ମୋତେ କ୍ୟାମ୍ପସ ମାନଚିତ୍ର ଦେଖାନ୍ତୁ",
                    office_hours: "କାର୍ଯ୍ୟାଳୟ ସମୟ କ'ଣ?",
                    library: "ମୋତେ ପୁସ୍ତକାଳୟ ବିଷୟରେ କୁହନ୍ତୁ",
                    contact: "ମୁଁ ପ୍ରଶାସନ ସହିତ କିପରି ଯୋଗାଯୋଗ କରିବି?",
                    talk_to_human: "ମୁଁ ଜଣେ ମଣିଷ ସହିତ କଥା କହିବାକୁ ଚାହୁଁଛି"
                }
            }
        };

        // Language detection patterns
        const languagePatterns = {
            hi: /[\u0900-\u097F]/,  // Devanagari script (Hindi/Marwari)
            bn: /[\u0980-\u09FF]/,  // Bengali script
            or: /[\u0B00-\u0B7F]/,  // Odia script
            mwr: /[\u0900-\u097F]/, // Marwari uses Devanagari (will need additional logic)
            en: /^[a-zA-Z\s\d\.,!?'"()-]+$/ // English characters only
        };

        // Marwari specific words for better detection
        const marwariWords = ['थारे', 'म्हैं', 'अठै', 'कैयां', 'सूं', 'रो', 'री', 'रे', 'हूं', 'आपणो', 'करूं', 'चाहूं', 'दो', 'दिखाओ', 'बताओ'];

        // Language detection function
        function detectLanguage(text) {
            const cleanText = text.trim().toLowerCase();
            
            // Check for Odia
            if (languagePatterns.or.test(text)) {
                return 'or';
            }
            
            // Check for Bengali
            if (languagePatterns.bn.test(text)) {
                return 'bn';
            }
            
            // Check for Devanagari (Hindi/Marwari)
            if (languagePatterns.hi.test(text)) {
                // Check if it's Marwari by looking for specific Marwari words
                const hasMarwariWords = marwariWords.some(word => 
                    cleanText.includes(word.toLowerCase())
                );
                
                if (hasMarwariWords) {
                    return 'mwr';
                }
                return 'hi';
            }
            
            // Default to English if no other language detected
            return 'en';
        }

        // Authentication functions
        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                type === 'error' ? 'bg-red-500 text-white' : 
                type === 'success' ? 'bg-green-500 text-white' : 
                'bg-blue-500 text-white'
            }`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validatePassword(password) {
            return password.length >= 6;
        }

        function generateSession() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function login(identifier, password) {
            const user = users.find(u => 
                (u.email === identifier || u.studentId === identifier) && u.password === password
            );
            
            if (user) {
                currentUser = user;
                const sessionId = generateSession();
                localStorage.setItem('sikshaSession', sessionId);
                localStorage.setItem('sikshaCurrentUser', JSON.stringify(user));
                return true;
            }
            return false;
        }

        function signup(name, email, studentId, password) {
            // Check if user already exists
            if (users.some(u => u.email === email || u.studentId === studentId)) {
                return false;
            }
            
            const newUser = {
                id: Date.now(),
                name,
                email,
                studentId,
                password,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('sikshaUsers', JSON.stringify(users));
            return login(email, password);
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('sikshaSession');
            localStorage.removeItem('sikshaCurrentUser');
            showAuthScreen();
        }

        function checkSession() {
            const session = localStorage.getItem('sikshaSession');
            const user = localStorage.getItem('sikshaCurrentUser');
            
            if (session && user) {
                currentUser = JSON.parse(user);
                showChatScreen();
                return true;
            }
            return false;
        }

        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            chatbotScreen.classList.add('hidden');
        }

        function showChatScreen() {
            authScreen.classList.add('hidden');
            chatbotScreen.classList.remove('hidden');
            if (currentUser) {
                userName.textContent = currentUser.name;
            }
        }

        // Auth event listeners
        showSignupBtn.addEventListener('click', () => {
            loginForm.classList.add('hidden');
            signupForm.classList.remove('hidden');
        });

        showLoginBtn.addEventListener('click', () => {
            signupForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
        });

        loginFormElement.addEventListener('submit', (e) => {
            e.preventDefault();
            const identifier = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!identifier || !password) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            if (login(identifier, password)) {
                showAlert('Login successful!', 'success');
                showChatScreen();
            } else {
                showAlert('Invalid credentials', 'error');
            }
        });

        signupFormElement.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const studentId = document.getElementById('signupStudentId').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!name || !email || !studentId || !password || !confirmPassword) {
                showAlert('Please fill in all fields', 'error');
                return;
            }
            
            if (!validateEmail(email)) {
                showAlert('Please enter a valid email address', 'error');
                return;
            }
            
            if (!validatePassword(password)) {
                showAlert('Password must be at least 6 characters long', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            if (signup(name, email, studentId, password)) {
                showAlert('Account created successfully!', 'success');
                showChatScreen();
            } else {
                showAlert('User with this email or student ID already exists', 'error');
            }
        });

        logoutButton.addEventListener('click', () => {
            // A simple confirmation message without a modal
            showAlert('Logging out...', 'info');
            setTimeout(logout, 500);
        });

        // Language functions
        function changeLanguage(lang) {
            currentLanguage = lang;
            updateLanguageDisplay();
            translateInterface();
            document.getElementById('languageDropdown').classList.remove('show');
        }

        function updateLanguageDisplay() {
            const languageCodes = {
                'en': 'EN',
                'hi': 'HI',
                'bn': 'BN',
                'mwr': 'MR',
                'or': 'OR'
            };
            document.getElementById('currentLanguage').textContent = languageCodes[currentLanguage];
        }

        function translateInterface() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
        }
        
        // Get localized query text
        function getLocalizedQuery(queryKey) {
            if (translations[currentLanguage] && translations[currentLanguage].queries && translations[currentLanguage].queries[queryKey]) {
                return translations[currentLanguage].queries[queryKey];
            }
            return translations.en.queries[queryKey]; // Fallback to English
        }

        // Language dropdown toggle
        document.getElementById('languageDropdownBtn').addEventListener('click', function() {
            document.getElementById('languageDropdown').classList.toggle('show');
        });

        window.addEventListener('click', function(event) {
            if (!event.target.matches('#languageDropdownBtn') && !event.target.closest('.language-dropdown')) {
                document.getElementById('languageDropdown').classList.remove('show');
            }
        });

        // Chat event listeners
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Event listener for Quick Actions buttons (updated to use data-query-key)
        quickActionsContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.queryKey) {
                const queryText = getLocalizedQuery(button.dataset.queryKey);
                sendMessage(queryText);
            }
        });

        // Event listener for "Talk to Human" button
        talkToHumanButton.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.queryKey) {
                const queryText = getLocalizedQuery(button.dataset.queryKey);
                sendMessage(queryText);
            }
        });

        // Display a message in the chat window
        function displayMessage(text, sender) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('flex', 'space-x-2', 'items-start');

            const messageContent = document.createElement('div');
            messageContent.classList.add('p-3', 'rounded-xl', 'max-w-[75%]', 'break-words', 'whitespace-pre-wrap', 'shadow-md');
            messageContent.textContent = text;
            
            const metaData = document.createElement('div');
            metaData.classList.add('flex', 'items-center', 'text-xs', 'text-gray-500', 'mt-2', 'space-x-1');
            metaData.innerHTML = `<span>${timeString}</span><span>|</span><span>${document.getElementById('currentLanguage').textContent}</span>`;

            messageContent.appendChild(metaData);

            if (sender === 'user') {
                messageWrapper.classList.add('flex-row-reverse', 'space-x-reverse');
                messageContent.classList.add('bg-blue-500', 'text-white', 'rounded-br-none');
            } else if (sender === 'bot') {
                const botIcon = document.createElement('div');
                botIcon.classList.add('flex-shrink-0');
                botIcon.innerHTML = `<svg class="h-8 w-8 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>`;
                messageWrapper.appendChild(botIcon);
                messageContent.classList.add('bg-gray-200', 'text-gray-800', 'rounded-bl-none');
            }
            messageWrapper.appendChild(messageContent);
            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayBotMessage(text, sender) {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
            displayMessage(text, sender);
        }

        function showTypingIndicator() {
            const typingElement = document.createElement('div');
            typingElement.id = 'typingIndicator';
            typingElement.classList.add('p-3', 'rounded-xl', 'bg-gray-200', 'text-gray-800', 'rounded-bl-none', 'animate-pulse');
            typingElement.textContent = 'typing...';
            
            const typingWrapper = document.createElement('div');
            typingWrapper.classList.add('flex', 'space-x-2', 'items-start');
            typingWrapper.innerHTML = `<svg class="h-8 w-8 text-indigo-600 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>`;
            typingWrapper.appendChild(typingElement);

            chatContainer.appendChild(typingWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage(message = messageInput.value.trim()) {
            const userMessage = message;
            if (!userMessage) return;

            displayMessage(userMessage, 'user');
            conversationHistory.push({ role: 'user', parts: [{ text: userMessage }] });
            messageInput.value = '';
            showTypingIndicator();
            
            try {
                const botResponse = await getBotResponse(userMessage);
                displayBotMessage(botResponse, 'bot');
                conversationHistory.push({ role: 'model', parts: [{ text: botResponse }] });
            } catch (error) {
                console.error("Error fetching bot response:", error);
                displayBotMessage("Sorry, I'm having trouble connecting right now. Please try again later.", 'bot');
            }
        }

        async function getBotResponse(prompt) {
            const languageNames = {
                en: 'English',
                hi: 'Hindi',
                bn: 'Bengali', 
                mwr: 'Marwari',
                or: 'Odia'
            };

            const systemPrompt = `You are Siksha-Saathi, a friendly and helpful campus information assistant for students. Your goal is to answer questions about campus life, fees, scholarships, and schedules based on institutional FAQs.
            You must respond in a conversational and positive tone.
            If the user asks a question you cannot answer, or if they explicitly ask to contact a human, you must respond with: "I'm not able to help with that. Please contact campus administration at [email address or phone number] for further assistance."
            Maintain context throughout the conversation.
            Please respond in the same language as the user's query.
            Current user: ${currentUser ? currentUser.name : 'Guest'} (Student ID: ${currentUser ? currentUser.studentId : 'N/A'})`;
            
            const payload = {
                contents: conversationHistory,
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };
            
            const apiKey = "AIzaSyCJ_yaYWpJpSdFQjqFLdDrKYETO4alGJwg";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let retries = 0;
            const maxRetries = 3;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            while (retries < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) {
                        if (response.status === 429) {
                            retries++;
                            await delay(1000 * Math.pow(2, retries));
                            continue;
                        }
                        throw new Error(`API response error: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        return candidate.content.parts[0].text;
                    } else {
                        throw new Error("Invalid API response format");
                    }
                } catch (error) {
                    retries++;
                    if (retries >= maxRetries) {
                        throw error;
                    }
                    await delay(1000 * Math.pow(2, retries));
                }
            }

            throw new Error("Failed to get bot response after multiple retries.");
        }

        // Initialize the application
        function initializeApp() {
            translateInterface();
            if (!checkSession()) {
                showAuthScreen();
            }
        }

        // Start the application
        initializeApp();
    </script>
</body>
</html>
